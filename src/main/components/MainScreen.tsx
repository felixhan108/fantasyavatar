"use client";

import { useEffect, useRef } from "react";
import Phaser from "phaser";

enum GameState {
  TRAVELING,
  ENCOUNTER,
  WAREND,
}

const AssetsKeys = {
  BACKGROUND: "background",
  SOLDIER_IDLE: "soldier-idle",
  SOLDIER_WALK: "soldier-walk",
  SLIME_IDLE: "slime-idle",
  SLIME_WALK: "slime-walk",
  SOLDIER_ATTACK: "soldier-attack",
  SLIME_ATTACK: "slime-attack",
  SOLDIER_HURT: "soldier-hurt",
  SLIME_HURT: "slime-hurt",
};

export default function MainScreen() {
  const phaserRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    // Î©îÏù∏ Ïî¨ ÌÅ¥ÎûòÏä§ Ï†ïÏùò
    class MainScene extends Phaser.Scene {
      private soldier!: Phaser.GameObjects.Sprite;
      private slime!: Phaser.GameObjects.Sprite;
      private background!: Phaser.GameObjects.TileSprite;
      private gameState!: GameState;
      private soldierHP: number = 100;
      private slimeHP: number = 100;
      private soldierHPText!: Phaser.GameObjects.Text;
      private battleTimer!: Phaser.Time.TimerEvent;
      private currentAttacker: "soldier" | "slime" = "soldier";

      constructor() {
        // ÏÉùÏÑ±ÏûêÏóêÏÑú Ïî¨ Ïù¥Î¶Ñ ÏÑ§Ï†ï
        super("MainScene");
      }

      // ============================
      // üß© preload()
      // ============================
      preload() {
        this.load.image(AssetsKeys.BACKGROUND, "/assets/bg/forest.png");

        // Ï∫êÎ¶≠ÌÑ∞ - Idle
        this.load.spritesheet(
          AssetsKeys.SOLDIER_IDLE,
          "/assets/sprites/Soldier-Idle.png",
          {
            frameWidth: 100, // ÎîîÏûêÏù∏Ïóê Ï†ïÌï¥ÎÜìÏùÄ Í∑∏Î¶¨Îìú ÏÇ¨Ïù¥Ï¶à
            frameHeight: 100,
          }
        );

        // Ï∫êÎ¶≠ÌÑ∞ - Walk
        this.load.spritesheet(
          AssetsKeys.SOLDIER_WALK,
          "/assets/sprites/Soldier-Walk.png",
          {
            frameWidth: 100, // ÎîîÏûêÏù∏Ïóê Ï†ïÌï¥ÎÜìÏùÄ Í∑∏Î¶¨Îìú ÏÇ¨Ïù¥Ï¶à
            frameHeight: 100,
          }
        );

        // Ï∫êÎ¶≠ÌÑ∞ - Attack
        this.load.spritesheet(
          AssetsKeys.SOLDIER_ATTACK,
          "/assets/sprites/Soldier-Attack01.png",
          {
            frameWidth: 100, // ÎîîÏûêÏù∏Ïóê Ï†ïÌï¥ÎÜìÏùÄ Í∑∏Î¶¨Îìú ÏÇ¨Ïù¥Ï¶à
            frameHeight: 100,
          }
        );

        // Ï∫êÎ¶≠ÌÑ∞ - Hurt
        this.load.spritesheet(
          AssetsKeys.SOLDIER_HURT,
          "/assets/sprites/Soldier-Hurt.png",
          {
            frameWidth: 100, // ÎîîÏûêÏù∏Ïóê Ï†ïÌï¥ÎÜìÏùÄ Í∑∏Î¶¨Îìú ÏÇ¨Ïù¥Ï¶à
            frameHeight: 100,
          }
        );
        // Ïä¨ÎùºÏûÑ - Idle
        this.load.spritesheet(
          AssetsKeys.SLIME_IDLE,
          "/assets/sprites/Slime-Idle.png",
          {
            frameWidth: 100, // ÎîîÏûêÏù∏Ïóê Ï†ïÌï¥ÎÜìÏùÄ Í∑∏Î¶¨Îìú ÏÇ¨Ïù¥Ï¶à
            frameHeight: 100,
          }
        );

        // Ïä¨ÎùºÏûÑ - Walk
        this.load.spritesheet(
          AssetsKeys.SLIME_WALK,
          "/assets/sprites/Slime-Walk.png",
          {
            frameWidth: 100, // ÎîîÏûêÏù∏Ïóê Ï†ïÌï¥ÎÜìÏùÄ Í∑∏Î¶¨Îìú ÏÇ¨Ïù¥Ï¶à
            frameHeight: 100,
          }
        );

        // Ïä¨ÎùºÏûÑ - Attack
        this.load.spritesheet(
          AssetsKeys.SLIME_ATTACK,
          "/assets/sprites/Slime-Attack01.png",
          {
            frameWidth: 100, // ÎîîÏûêÏù∏Ïóê Ï†ïÌï¥ÎÜìÏùÄ Í∑∏Î¶¨Îìú ÏÇ¨Ïù¥Ï¶à
            frameHeight: 100,
          }
        );

        // Ïä¨ÎùºÏûÑ - Hurt
        this.load.spritesheet(
          AssetsKeys.SLIME_HURT,
          "/assets/sprites/Slime-Hurt.png",
          {
            frameWidth: 100, // ÎîîÏûêÏù∏Ïóê Ï†ïÌï¥ÎÜìÏùÄ Í∑∏Î¶¨Îìú ÏÇ¨Ïù¥Ï¶à
            frameHeight: 100,
          }
        );
      }

      // ============================
      // üß© create()
      // ============================
      create() {
        this.gameState = GameState.ENCOUNTER;

        this.background = this.add
          .tileSprite(0, 0, 480, 160, AssetsKeys.BACKGROUND)
          .setOrigin(0, 0);

        // Î≥ëÏÇ¨ HP ÌÖçÏä§Ìä∏Îßå ÏÉùÏÑ±
        this.soldierHPText = this.add.text(5, 5, `HP: ${this.soldierHP}`, {
          fontSize: "10px",
          color: "#ffffff",
        });

        // Î≥ëÏÇ¨ Ïï†ÎãàÎ©îÏù¥ÏÖò ÏÉùÏÑ±
        this.anims.create({
          key: "idle",
          frames: this.anims.generateFrameNumbers(AssetsKeys.SOLDIER_IDLE, {
            start: 0,
            end: 5,
          }),
          frameRate: 12, // Ï¥àÎãπ 12ÌîÑÎ†àÏûÑ
          repeat: -1, // Î¨¥Ìïú Î∞òÎ≥µ
        });

        this.anims.create({
          key: "walk",
          frames: this.anims.generateFrameNumbers(AssetsKeys.SOLDIER_WALK, {
            start: 0,
            end: 7,
          }),
          frameRate: 12,
          repeat: -1,
        });

        this.anims.create({
          key: "attack",
          frames: this.anims.generateFrameNumbers(AssetsKeys.SOLDIER_ATTACK, {
            start: 0,
            end: 6,
          }),
          frameRate: 12,
          repeat: 0,
        });

        this.anims.create({
          key: "hurt",
          frames: this.anims.generateFrameNumbers(AssetsKeys.SOLDIER_HURT, {
            start: 0,
            end: 3,
          }),
          frameRate: 12,
          repeat: 0,
        });

        // Ïä¨ÎùºÏûÑ Ïï†ÎãàÎ©îÏù¥ÏÖò ÏÉùÏÑ±
        this.anims.create({
          key: "slime-idle",
          frames: this.anims.generateFrameNumbers(AssetsKeys.SLIME_IDLE, {
            start: 0,
            end: 5,
          }),
          frameRate: 12,
          repeat: -1,
        });

        this.anims.create({
          key: "slime-attack",
          frames: this.anims.generateFrameNumbers(AssetsKeys.SLIME_ATTACK, {
            start: 0,
            end: 6,
          }),
          frameRate: 12,
          repeat: 0,
        });

        this.anims.create({
          key: "slime-hurt",
          frames: this.anims.generateFrameNumbers(AssetsKeys.SLIME_HURT, {
            start: 0,
            end: 3,
          }),
          frameRate: 12,
          repeat: 0,
        });

        this.soldier = this.add.sprite(50, 75, AssetsKeys.SOLDIER_IDLE);
        this.soldier.play("idle");

        // 1Ï¥à Îí§Ïóê walk Ïï†ÎãàÎ©îÏù¥ÏÖòÏúºÎ°ú Î≥ÄÍ≤Ω
        this.time.delayedCall(1000, () => {
          this.gameState = GameState.TRAVELING;
          this.soldier.play("walk");
          this.startRandomEncounter();
        });
      }

      // HP ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò ÏàòÏ†ï
      private updateHP() {
        this.soldierHPText.setText(`HP: ${this.soldierHP}`);
      }

      startRandomEncounter() {
        const randomTime = Phaser.Math.Between(5000, 10000);
        this.time.delayedCall(randomTime, () => {
          if (this.gameState === GameState.TRAVELING) {
            this.startBattle();
          }
        });
      }

      startBattle() {
        this.gameState = GameState.ENCOUNTER;
        this.soldier.play("idle");

        // Ïä¨ÎùºÏûÑ ÏÉùÏÑ± (HP ÌÖçÏä§Ìä∏ ÏóÜÏù¥)
        this.slime = this.add.sprite(100, 75, AssetsKeys.SLIME_IDLE);
        this.slime.setFlipX(true);
        this.slime.play("slime-idle");

        // Ï†ÑÌà¨ ÌÉÄÏù¥Î®∏ ÏãúÏûë
        this.battleTimer = this.time.addEvent({
          delay: 1000,
          callback: this.executeAttack,
          callbackScope: this,
          loop: true,
        });
      }

      executeAttack() {
        if (this.gameState !== GameState.ENCOUNTER) {
          this.battleTimer.destroy();
          return;
        }

        // Í∞ùÏ≤¥Í∞Ä Ï°¥Ïû¨ÌïòÎäîÏßÄ ÌôïÏù∏
        if (!this.soldier || !this.slime) {
          this.battleTimer.destroy();
          return;
        }

        if (this.currentAttacker === "soldier") {
          // Î≥ëÏÇ¨ Í≥µÍ≤©
          this.soldier.play("attack");
          this.soldier.once("animationcomplete", () => {
            if (this.soldier) {
              this.soldier.play("idle");
            }
          });

          this.time.delayedCall(500, () => {
            if (!this.slime) return;

            this.slime.play("slime-hurt");
            this.slime.once("animationcomplete", () => {
              if (this.slime) {
                this.slime.play("slime-idle");
              }
            });
            const damage = Phaser.Math.Between(30, 50);
            this.slimeHP -= damage;
            this.updateHP();
            this.checkBattleEnd();
          });
        } else {
          // Ïä¨ÎùºÏûÑ Í≥µÍ≤©
          this.slime.play("slime-attack");
          this.slime.once("animationcomplete", () => {
            if (this.slime) {
              this.slime.play("slime-idle");
            }
          });

          this.time.delayedCall(500, () => {
            if (!this.soldier) return;

            this.soldier.play("hurt");
            this.soldier.once("animationcomplete", () => {
              if (this.soldier) {
                this.soldier.play("idle");
              }
            });
            const damage = Phaser.Math.Between(10, 20);
            this.soldierHP -= damage;
            this.updateHP();
            this.checkBattleEnd();
          });
        }

        // Îã§Ïùå Í≥µÍ≤©Ïûê Î≥ÄÍ≤Ω
        this.currentAttacker =
          this.currentAttacker === "soldier" ? "slime" : "soldier";
      }

      checkBattleEnd() {
        if (this.soldierHP <= 0 || this.slimeHP <= 0) {
          // Î®ºÏ†Ä ÌÉÄÏù¥Î®∏ÏôÄ ÏÉÅÌÉú Î≥ÄÍ≤Ω
          this.battleTimer.destroy();
          this.gameState = GameState.WAREND;

          // Î≥ëÏÇ¨ ÏÉÅÌÉú Î≥ÄÍ≤Ω
          if (this.soldier) {
            this.soldier.play("walk");
          }
          this.gameState = GameState.TRAVELING;

          // Ïä¨ÎùºÏûÑÍ≥º Í¥ÄÎ†®Îêú Î™®Îì† Ïï†ÎãàÎ©îÏù¥ÏÖò Ï§ëÏßÄ
          if (this.slime) {
            this.slime.stop();
            this.slime.setVisible(false);
            this.slime.setActive(false);
          }

          // Îã§Ïùå ÌîÑÎ†àÏûÑÏóêÏÑú Ïä¨ÎùºÏûÑ Ï†úÍ±∞
          this.time.delayedCall(0, () => {
            if (this.slime) {
              this.slime.destroy();
            }

            // HP Ï¥àÍ∏∞Ìôî
            this.soldierHP = 100;
            this.slimeHP = 100;
            this.updateHP();

            // ÏÉàÎ°úÏö¥ Ïù∏Ïπ¥Ïö¥ÌÑ∞ ÏãúÏûë
            this.startRandomEncounter();
          });
        }
      }

      // ============================
      // üß© update()
      // ============================
      update() {
        if (this.gameState === GameState.TRAVELING) {
          this.background.tilePositionX += 1;
        }
      }
    }

    // ============================
    // üß© config
    // ============================
    const config: Phaser.Types.Core.GameConfig = {
      type: Phaser.WEBGL,
      width: 16 * 10,
      height: 16 * 10,
      parent: phaserRef.current,
      scene: MainScene,
      pixelArt: true,
      zoom: 2,
    };

    // Í≤åÏûÑ Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ±
    const game = new Phaser.Game(config);

    return () => {
      // Ïª¥Ìè¨ÎÑåÌä∏Í∞Ä Ïñ∏ÎßàÏö¥Ìä∏Îê† Îïå Í≤åÏûÑ Ïù∏Ïä§ÌÑ¥Ïä§ Ï†úÍ±∞
      game.destroy(true);
    };
  }, []);

  return (
    <>
      <div ref={phaserRef} />
    </>
  );
}
